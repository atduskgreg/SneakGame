<html>
  <head>
    <style>
    #board {
      float: left;
      margin-right: 20px;
    }

    #board td{
      border: 1px solid #000;
      margin: 0;
      min-width: 75;
      width: 75;
      height: 75;
      min-height: 75;
    }

    .squareDescription{
      color: #aaa;
    }

    #players {
      float: left;
    }

    table p {
      margin: 0;
      border: 1px solid #ccc;
      color: #fff;
    }

    .highlight {
      background-color: #cfc;
    }

    .path {
      background-color: #fcc;
    }

    .door {
      background-color: #cca;
    }

    #board td.nDoor{
      border-top: 5px solid white;
    }
    #board td.eDoor{
      border-right: 5px solid white;
    }
    #board td.wDoor{
      border-left : 5px solid white;
    }
    #board td.sDoor {
      border-bottom:5px solid white;
    }

    #moveInput button {
      width: 200px;
      height: 30px;
    }

    #moveInput .buttonSpacer {
      min-width: 200px;
      min-height: 30px;
    }

    .gun {
      background-image: url('public/gun.jpg');
      background-repeat: no-repeat;
      background-position: center;
      border: 2px solid #000;
    }

    #checklist td{
      width: 50px;
      height: 50px;
      border: 2px solid;
      text-align: center;
      font-size: 40;
      font-family: sans-serif;
      padding-top: 7;
    }

    #checklist td.newKnowledge {
      border: 2px dotted red;
    }

    #checklist td.newKnowledgeRed {
      border: 2px dotted yellow;
    }

    .characterDisplay {
      font-weight: bold;
    }

    .blackKnowledge{
      color: white;
    }

    .redCharacter {
      color: red;
    }
    .blueCharacter {
      color: blue;
    }
    .greenCharacter {
      color: green;
    }
    .yellowCharacter {
      color: yellow;
      -webkit-text-stroke: 1px gray;
    }
    .blackCharacter {
      color: black;
    }
    .whiteCharacter {
      -webkit-text-stroke: 1px gray;
      color: white;
    }
    .orangeCharacter {
      color: orange;
    }
    .pinkCharacter {
      color: pink;
    }
    .grayCharacter {
      color: gray;
    }
    .brownCharacter {
      color: brown;
    }


    </style>



    <script type="text/x-handlebars">
      {{outlet}}

      <br style="clear:both" />
      {{#view "debug" isVisibleBinding="debugIsVisible"}}
        <!-- <button {{action 'refreshDebug'}}>refresh</button> --> <!-- temporary hack until game is an ember model -->
        {{debug-view}}
      {{/view}}

      <p><em><a href="#" {{action "toggleDebug"}}>Toggle debug view</a></em></p>

    </script>
  
    <script type="text/x-handlebars" id ="index">
      <h1>Sneak</h1>
       <label>Play game on-screen?</label> {{view Ember.Checkbox checkedBinding="model.onScreen"}}

      <p>{{#link-to 'setup'}}Start game{{/link-to}}</p>
    </script>
  
    <script type="text/x-handlebars" id="setup">
      <h1>Setup</h1>
      {{# if onScreen}}
      {{ else }}
      <p>Exit is: {{format-square exit}}</p>
      
      <ul>
      {{#each item in instructions}}
        <li>{{item.instruction}}</li>
      {{/each}}
      </ul>

      {{/if}}

      <p><b>Character rank</b> <em>breaks ties for picking up objects. If multiple characters arrive at the same object at the same time, the character with the higher rank will get to pick up the object.</em></p>
      <p><b>Rank in ascending order</b>: <em>{{rank-list}}</em></p>
      <p>{{#link-to 'characterAssignment'}}Find out your characters{{/link-to}}</p>
    </script>
    
    <script type="text/x-handlebars" id="characterAssignment">
      <h1>Player character assignments</h1>
      {{#if PassManager.isPassing}}
        {{partial 'pass'}}
      {{else}}
        <p>You are {{current-player-rank-color}}.</p>
        <p><button {{action 'next'}}>Got it</button></p>
      {{/if}}
    </script>
    
    <script type="text/x-handlebars" id="poison">
    <h1>Select someone to poison</h1>
    {{#if PassManager.isPassing}}
        {{partial 'pass'}}
    {{else}}
      (You are {{ current-player-rank-color }})
      {{#if canPoison }}
        {{#if noTargets}}
          <p>No one to poison here. <button {{action "next"}}>Continue</button></p>
        {{ else }}

          <form {{action "poison" on="submit"}}>
            {{view "select" contentBinding="targets" valueBinding='targetColor' selection=firstTarget}}
            <button type="submit">Poison</button>
          </form>
          or
          <button {{action "next"}}>Skip</button>
        {{/if}}
      {{else}}
        <p>You already used your poison. <button {{action "next"}}>Continue</button></p>
      {{/if}}
    {{/if}}

    </script>

    <script type="text/x-handlebars" id="moves">
      <h1>Input moves</h1>
      {{#if PassManager.isPassing}}
        {{partial 'pass'}}
      {{else}}
        <p>You are {{current-player-rank-color}}.</p>
        <div id="moveInput">
        <p>
          {{#if shoot}}
            <button {{action "submitMove" "shoot" }}>shoot gun</button>
            <button {{action "submitMove" "drop" }}>drop gun</button>
          {{else }}
            {{#if onScreen}}
              <p>
                {{#if nw}}
                  <button {{action "submitMove" "nw" }}>nw</button>
                {{else}}
                  <button disabled>nw</button> 
                {{/if}}
                
                {{#if n}}
                <button {{action "submitMove" "n" }}>n</button>
                {{else}}
                  <button disabled>n</button> 
                {{/if}}
      
                {{#if ne}}
                <button {{action "submitMove" "ne" }}>ne</button>
                {{else}}
                  <button disabled>ne</button> 
                {{/if}}
              </p>

              <p>        
                {{#if w}}
                  <button {{action "submitMove" "w" }}>w</button>
                {{else}}
                  <button disabled>w</button> 
                {{/if}}
    
                <button {{action "submitMove" "hold" }}>hold</button>
                
                {{#if e}}
                  <button {{action "submitMove" "e" }}>e</button>
                {{else}}
                  <button disabled>e</button> 
                {{/if}}
              </p>
              <p>        
                {{#if sw}}
                  <button {{action "submitMove" "sw" }}>sw</button>
                {{else}}
                  <button disabled>sw</button> 
                {{/if}}
      
                {{#if s}}
                  <button {{action "submitMove" "s" }}>s</button>
                {{else}}
                  <button disabled>s</button> 
                {{/if}}
      
                {{#if se}}
                 <button {{action "submitMove" "se" }}>se</button>
                {{else}}
                  <button disabled>se</button> 
                {{/if}}
              </p>
            {{ else }}

              {{#if position-top}} <!-- south is up, west is right -->
                <p>        
                  {{#if se}}
                   <button {{action "submitMove" "se" }}>se</button>
                  {{else}}
                    <button disabled>se</button> 
                  {{/if}}
        
                  {{#if s}}
                    <button {{action "submitMove" "s" }}>s</button>
                  {{else}}
                    <button disabled>s</button> 
                  {{/if}}
        
                  {{#if sw}}
                    <button {{action "submitMove" "sw" }}>sw</button>
                  {{else}}
                    <button disabled>sw</button> 
                  {{/if}}
                </p>
                <p>        
      
                  {{#if e}}
                    <button {{action "submitMove" "e" }}>e</button>
                  {{else}}
                    <button disabled>e</button> 
                  {{/if}}
  
                  <button {{action "submitMove" "hold" }}>hold</button>
                  
                  {{#if w}}
                    <button {{action "submitMove" "w" }}>w</button>
                  {{else}}
                    <button disabled>w</button> 
                  {{/if}}
                </p>
                <p>
                  {{#if ne}}
                  <button {{action "submitMove" "ne" }}>ne</button>
                  {{else}}
                    <button disabled>ne</button> 
                  {{/if}}
                  
                  {{#if n}}
                  <button {{action "submitMove" "n" }}>n</button>
                  {{else}}
                    <button disabled>n</button> 
                  {{/if}}
  
                  {{#if nw}}
                    <button {{action "submitMove" "nw" }}>nw</button>
                  {{else}}
                    <button disabled>nw</button> 
                  {{/if}}
                </p>
              
              {{else}}
                <p>
                  {{#if nw}}
                    <button {{action "submitMove" "nw" }}>nw</button>
                  {{else}}
                    <button disabled>nw</button> 
                  {{/if}}
                  
                  {{#if n}}
                  <button {{action "submitMove" "n" }}>n</button>
                  {{else}}
                    <button disabled>n</button> 
                  {{/if}}
        
                  {{#if ne}}
                  <button {{action "submitMove" "ne" }}>ne</button>
                  {{else}}
                    <button disabled>ne</button> 
                  {{/if}}
                </p>
  
                <p>        
                  {{#if w}}
                    <button {{action "submitMove" "w" }}>w</button>
                  {{else}}
                    <button disabled>w</button> 
                  {{/if}}
      
                  <button {{action "submitMove" "hold" }}>hold</button>
                  
                  {{#if e}}
                    <button {{action "submitMove" "e" }}>e</button>
                  {{else}}
                    <button disabled>e</button> 
                  {{/if}}
                </p>
                <p>        
                  {{#if sw}}
                    <button {{action "submitMove" "sw" }}>sw</button>
                  {{else}}
                    <button disabled>sw</button> 
                  {{/if}}
        
                  {{#if s}}
                    <button {{action "submitMove" "s" }}>s</button>
                  {{else}}
                    <button disabled>s</button> 
                  {{/if}}
        
                  {{#if se}}
                   <button {{action "submitMove" "se" }}>se</button>
                  {{else}}
                    <button disabled>se</button> 
                  {{/if}}
                </p>
              {{/if}} <!-- /position-top/bottom  -->
            {{/if}} <!-- /onScreen -->
          {{/if}}

        </div>
        {{/if}}
    </script>

    <script type="text/x-handlebars" id="shoot">
      <h1>Pick Target</h1>
      <p>You are {{current-player-color}} ({{current-player-name}}).</p>
      <form {{action "fire" on="submit"}}>
        {{view "select" content=targets valueBinding='targetColor'}}
        <button type="submit">Shoot</button>
      </form>
    </script>
    
    <script type="text/x-handlebars" id="moveInstructions">
      {{#if onScreen}}
      {{ else }}
        <h1>Move Instructions</h1>
        <ul>
        {{#each instruction in instructions}}
          <li>{{ instruction }}</li>
        {{/each}}
      </ul>
      {{/if}}
      <h2>Victims</h2>
      <ul>
      {{#each deathDescription in victims}}
        <li>{{ deathDescription }}</li>
      {{/each}}
      </ul>
      {{#if onScreen}}
        <button {{action "confirm"}}>Next</button>
      {{ else }}
      <button {{action "confirm"}}>Done moving</button>
      {{/if}}

    </script>

    <script type="text/x-handlebars" id="_pass">
      <p>Pass the screen to {{ current-player-public }}</p>
      <p><button {{action 'next'}}>Done</button></p>
    </script>

    <script type="text/x-handlebars" id="dialogs">
      <h1>Dialogs ({{length}})</h1>
      <ul> 
        {{#each item in controller}}
        <li>
          {{item.summary}}
        </li>
        {{/each}}
      </ul>
      <p>{{#link-to 'dialogReveals'}}Reveal dialog results{{/link-to}}</p>
    </script>
  
     <script type="text/x-handlebars" id="dialogReveals">
      <h1>Dialog Reveal</h1>
      {{#if PassManager.isPassing}}
        {{partial 'pass'}}
      {{else}}
        <h3>Your Knowledge</h3>
        {{ current-player-knowledge }}
        <h3>Your Inventory</h3>
        <ul>
        {{current-player-inventory}}
        </ul>
        <p><button {{action 'next'}}>Got it</button></p>
      {{/if}}
    </script>

    <script type="text/x-handlebars" id="victory">
    <h1>Game Over</h1>
    {{#if oneWinner }}
      <h2>{{result.winner.color}} is the winner!</h2>
      <p>{{result.message}}</p>
    {{else}}
      <h2>{{result.message}}</h2>

    {{/if}}
  </script>

    <script src="js/libs/jquery-1.10.2.js"></script>
    <script src="js/libs/handlebars-v2.0.0.js"></script>
    <script src="js/libs/ember-1.9.1.js"></script>
    <script src="js/libs/ember-data.js"></script>
    <script src="js/libs/localstorage_adapter.js"></script>
    <script src="js/libs/ember-states.js"></script>
    <script src="js/libs/Queue.js"></script>
    <script src="js/libs/p5.min.js"></script>

    <script src="js/map.js"></script>
    <script src="js/game.js"></script>
    <script src="js/util.js"></script>
    <script src="js/character.js"></script>
    <script src="js/player.js"></script>

    <script src="js/app.js"></script>
    <script>
      var gridSize = 50;
      var mapSize = {};
      var images = [];
      var filenames = ["emt", "wll", "dor", "hll", "hdr", "cnr", "cd1"];


      function preload(){

        for(var i = 0; i < filenames.length; i++){
          images.push(loadImage( "/public/pieces/" + filenames[i] +".png"));
        }
      }

      function setup(){
        Map.setup();
        console.log(Game.boardWidth + "," + Game.boardHeight)
        mapSize = {width : (50*Game.boardWidth + 50), height : (50*Game.boardHeight+50)}
        canvas = createCanvas(mapSize.width + 200,mapSize.height);
        noLoop();
      }

      function drawGrid(){
        strokeWeight(0.1);
        squaresPerCell = 4;


        for(var row = 0; row < Game.boardHeight*4+1; row++){
          for(var col = 0; col < Game.boardWidth*4+1; col++){
            x = 25 + col*gridSize/squaresPerCell;
            y = 25 + Game.boardHeight*gridSize;
                    stroke(75,75,255);

            if(col % 4 == 0){
              strokeWeight(1);
            } else {
              strokeWeight(0.5);
              stroke(40,40, 255);
            }
            line(x, 25, x, y);


            line(25,x,y,x);



            // Debug: draw coordinate labels
            // if(col < Game.boardWidth && row < Game.boardHeight){
            //   stroke(125);
            //   text(col + "," + row,  col * gridSize , mapSize.height - row*gridSize );
            // }
          }
        }
      }

      function cellPos(cell){
        x = gridSize/2 + gridSize * cell.col - 5;
        y = (mapSize.height-gridSize/2) - gridSize*(cell.row+1) - 5;
        return {x: x, y: y};
      }


      function drawDoors(){
        noFill();
        doorCells = Map.getDoorCells();
        strokeWeight(1);
        for(var i = 0; i < doorCells.length; i++){
          doorDir = Map.doorDirection(doorCells[i]);
          pos = cellPos(doorCells[i]);
          stroke(125);

          if(doorDir == "n"){
            // line(pos.x, pos.y, pos.x+gridSize-5, pos.y+10)

            arc(pos.x+50, pos.y, 100, 100, HALF_PI, PI);
            line(pos.x+50,pos.y, pos.x+50, pos.y+50);
          }
          if(doorDir == "s"){
            arc(pos.x+gridSize,pos.y+gridSize, 100, 100, PI, PI+HALF_PI);
            line(pos.x+gridSize,pos.y+gridSize, pos.x+gridSize, pos.y);

          }

          if(doorDir == "w"){
            arc(pos.x, pos.y, 100, 100, 0, HALF_PI);
            line(pos.x,pos.y, pos.x+50, pos.y);
          }

          if(doorDir == "w"){
            arc(pos.x, pos.y, 100, 100, 0, HALF_PI);
            line(pos.x,pos.y, pos.x+50, pos.y);
          }
        }
      }

      function westWall(){
        rect(pos.x, pos.y, 10, gridSize);
        // line(pos.x, pos.y, pos.x, pos.y+gridSize);
        // line(pos.x+10, pos.y, pos.x+10, pos.y+gridSize);
      }
      function eastWall(){
        rect(pos.x+gridSize, pos.y, 10, gridSize);
        // line(pos.x+gridSize, pos.y, pos.x+gridSize, pos.y+gridSize);
        // line(pos.x+gridSize+10, pos.y+10, pos.x+gridSize+10, pos.y+gridSize+10);
      }
      function northWall(){
        rect(pos.x, pos.y, gridSize, 10);
        // line(pos.x, pos.y, pos.x+gridSize, pos.y);
        // line(pos.x, pos.y+10, pos.x+gridSize, pos.y+10);
      }

      function southWall(){
        rect(pos.x,pos.y+gridSize, gridSize, 10);
        // line(pos.x, pos.y+gridSize, pos.x+gridSize, pos.y+gridSize);
        // line(pos.x, pos.y+gridSize+10, pos.x+gridSize, pos.y+gridSize+10);
      }

      function drawCell(cell){



        dNeighbors = Map.getDisconnectedNeighbors(cell);
        pos = cellPos(cell);

        noFill();
        strokeWeight(1);
        stroke(125);

        if(!cell.indoors){
          nHatches = 5;
          for(var i = 0; i < nHatches; i++){
            line(pos.x+5, pos.y+5 +  gridSize/nHatches * i, pos.x  +5+  gridSize/nHatches * i, pos.y +5);

            line(pos.x+5 +  gridSize/nHatches * i, pos.y +gridSize+5, pos.x +gridSize+5, pos.y +  gridSize/nHatches * i + 5);

          }
        }

        strokeWeight(1);
        stroke(255);

        for(var i = 0; i < dNeighbors.length; i++){
          wallDir = Util.cardinalDescription(cell,dNeighbors[i]);
          if(wallDir == "n"){
            // rect(pos.x, pos.y, gridSize , 10);
            northWall();
          }
          if(wallDir == "s"){
            // rect(pos.x, pos.y + gridSize, gridSize , 10);
            southWall();
          }
          if(wallDir == "e"){
            // rect(pos.x+gridSize, pos.y, 10 , gridSize);
            eastWall();
          }
          if(wallDir == "w" ){
            westWall();
            // rect(pos.x, pos.y, 10 , gridSize);
          }
        
         
        }
        if(cell.indoors && !Map.getNeighbor(cell, {col: -1 , row: 0})){
          westWall();
          // rect(pos.x, pos.y, 10 , gridSize);
        }
        if(cell.indoors &&!Map.getNeighbor(cell, {col: 1 , row: 0})){
          // rect(pos.x+gridSize, pos.y, 10 , gridSize);
          eastWall();
        }
        if(cell.indoors &&!Map.getNeighbor(cell, {col: 0 , row: 1})){
            // rect(pos.x, pos.y, gridSize , 10);
            northWall();
        }
        if(cell.indoors && !Map.getNeighbor(cell, {col: 0 , row: -1})){
            // rect(pos.x, pos.y + gridSize, gridSize , 10);
            southWall();
        }
      }

      function drawMap(){
        for(var i = 0; i < Map.cells.length; i++){
          drawCell(Map.cells[i]);
          drawCellLabel(Map.cells[i]);
        }
      }

      function drawCellLabel(cell){
        pos = cellPos(cell);
        noStroke();
        fill(125,125,255);
        text(Map.partForCell(cell), pos.x +20, pos.y+(gridSize-20));
      }

      function drawKey(){
        w = 354;
        h = 479;

        scaledW = 70;
        scaledH = (scaledW / 354) * h;

        col = 0;
        row = 0;
        noStroke();
        fill(125);
        textAlign(CENTER);
        textSize(14);

        for(var i = 0; i < images.length; i++){
          x = mapSize.width + col*90;
          y = 25 + scaledH*row;
          console.log(col)
          image(images[i], x, y + 20*row, 70, scaledH);
          text(filenames[i], x + 30, y + scaledH + 20*row + 15);
          col++;
          if(col > 1){
            col = 0;
            row++;
          }
        }
      }

      function draw(){
        background(0,0,255);

        drawGrid();
        drawDoors();
        drawMap();

        drawKey();
      }


    </script>
  </head>
  <body>
  </body>
</html>