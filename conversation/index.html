<html>
<head>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>	
	<script src="/js/knowledge.js"></script>	
	<script src="/js/dialogue.js"></script>	

	<style>
		.actor {
			font-weight: bold;
		}

		.role {
			font-weight: bold;
		}

		#instructions p {
			font-style: italic;
		}

		#dialogue {
			display: none;
		}

		#who {
			border-bottom: 1px solid #000;
		}
	</style>


	<script>
	 function ready(){
	 	gameId = 'game ' + window.location.pathname.split("/")[2];

	 	var socket = io();
		socket.emit('join', gameId);




		function rollCharacter(){
	 		names = ["Pam", "Kit", "Van", "Lin"];
	 		name = names[Math.floor(Math.random() * names.length)];
	 		player = {
	 			knowledge : {},
	 			name : name
	 		}
	
	 		maxKnowledge = 6;
	 		nKnowledge = Math.floor(Math.random() * maxKnowledge) + 3;
	
	 		for(var i = 0; i < nKnowledge; i++){
	 			k = randomKnowledge();
	 			player.knowledge[k.what] = {where: k.where, when: k.when};
	 		}

	 		return player;
		}

	 	allSubjects = ["Joe", "Bob", "Jane", "Cat", "Alice", "Fin", "Mark", "the document safe", "the plans", "the exit", "the gun"];

	 	var player = rollCharacter();


	 	var characters = [];
	 	var character = {};
	 	var questionReceived = false;
	 	var questionSent = false;
	 	var questions = {};
	 	

	 	socket.emit("register-character", player);

	 	socket.on('update-characters',function(characterId, _characters){
	 		console.log("update-characters");
	 		characters = _characters;
	 		console.log(characters);
	 		for(var i = 0; i < characters.length; i++){
	 			if(characters[i].name != player.name){
	 				character = characters[i];
	 			}
	 		}

	 		$("#instructions .actor1").html(character.name);
	 		$(".actor1-name").html(character.name);
	 		$(".actor1 .actor").html(character.name);
	 	
	 		$(".actor2 .actor").html(player.name);
	 		$(".actor2-name").html(player.name);
	 		$("#instructions .actor2").html(player.name);

	 		$("#subject").submit(function(e){
				e.preventDefault();
				subject = $("#subject select").val();
	
				question = {
					subject : subject,
					from : player
				}

				questions[player] = subject;

	
				console.log(subject);
	
				socket.emit("submit-question", question);
				questionSent = true;
				$("form").hide();

				if(questionReceived){
					questionsComplete();
				}				
			});
	 	});

		function questionsComplete(){
			args = {
				character1 : characters[0],
				character2 : characters[1],
				dialogue : dialogues[1],
				subjects : [questions[characters[0]], questions[characters[1]]]
			}
			populateDialogue($("#dialogue"), args);
			$("#subject").hide();
			showScript();
		}
		

		socket.on('receive-question', function(data){
			console.log("received  question: " );
			console.log(data);
			questionReceived = true;
			questions[data.from] = data.subject;
			if(questionSent){
				questionsComplete();
			}
		});

		function showOptions(){
			for(var i = 0; i < allSubjects.length; i++){
				$("#subject select").append("<option value='"+allSubjects[i]+"'>"+allSubjects[i]+"</option>")
			}
		}

		



		function showScript(){

			$("#dialogue").show();
			$(".response").show();
  			$("#answers li").hide();
  			$("#answers").show();
  			$(".elipses").remove();
  			$("p").show();
		}

		showOptions();
	}

	 document.addEventListener("DOMContentLoaded", ready, false);

	</script>
</head>
<body>

	<div id="instructions">
		<div id="who">
			<p><span class="role actor1">Jim</span> talking to <span class="role actor2">Bob</span> (<b>YOU</b>)</p>
		</div>
		<form id="subject" action="">
			<p><label>Choose a subject to ask about</label> <select name=""></select> <input type="submit" value="ask" /></p>
		</form>
	</div>
	<div id="dialogue">
	</div>
</body>
</html>