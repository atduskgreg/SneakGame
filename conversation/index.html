<html>
<head>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>	
	<script src="/js/knowledge.js"></script>	
	<script src="/js/dialogue.js"></script>	
	<script src="/js/countdown.js"></script>	

	<style>
		.actor {
			font-weight: bold;
		}

		.role {
			font-weight: bold;
		}

		#instructions p {
			font-style: italic;
		}

		#dialogue {
			display: none;
		}

		#who {
			border-bottom: 1px solid #000;
		}
	</style>


	<script>
	var characters = [];

	 function ready(){
	 	gameId = 'game ' + window.location.pathname.split("/")[2];

	 	var socket = io();
		socket.emit('join', gameId);


	 	$("input").prop("disabled", true);


		function rollCharacter(){
	 		names = ["Pam", "Kit", "Van", "Lin"];
	 		name = names[Math.floor(Math.random() * names.length)];
	 		player = {
	 			knowledge : {},
	 			name : name
	 		}
	
	 		maxKnowledge = 6;
	 		nKnowledge = Math.floor(Math.random() * maxKnowledge) + 3;
	
	 		for(var i = 0; i < nKnowledge; i++){
	 			k = randomKnowledge();
	 			player.knowledge[k.what] = {where: k.where, when: k.when};
	 		}

	 		return player;
		}

	 	allSubjects = ["Joe", "Bob", "Jane", "Cat", "Alice", "Fin", "Mark", "the document safe", "the plans", "the exit", "the gun"];

	 	var player = rollCharacter();
	 	socket.emit("register-character", player);

	 	//var characters = [];
	 	var character = {};
	 	var questions = {};
	 	var questionReceived = false;
	 	var questionSent = false;
	 	var eventAttached = false;

	 	socket.on('update-characters',function(characterId, _characters){
	 		console.log("update-characters");
			console.log(_characters.length);
	 		characters = _characters;
	 		console.log(characters);
	 		for(var i = 0; i < characters.length; i++){
	 			if(characters[i].name != player.name){
	 				character = characters[i];
	 			}
	 		}
	
		 	if(_characters.length == 2 ){
	 			$("input").prop("disabled", false);
	 		}

	 		$("#instructions .actor1").html(character.name);
	 		$(".actor1-name").html(character.name);
	 		$(".actor1").html(character.name);


	 		$(".actor2r").html(player.name);
	 		$(".actor2-name").html(player.name);
	 		$("#instructions .actor2").html(player.name);

	 	});

	 	$("#subject").submit(function(e){
			e.preventDefault();
			subject = $("#subject select").val();
	
			question = {
				question : questionAbout(subject),
				answer : answerFor(subject, character.knowledge[subject]),
				from : player.name
			}

			questions[player.name] = question;

			console.log(player.name);

			console.log(subject);
	
			socket.emit("submit-question", question);
			questionSent = true;
			$("form").hide();

			if(questionReceived){
				questionsComplete();
			}				
		});

		function questionsComplete(){

			console.log("questions");
			console.log(questions);
			console.log("characters");
			console.log(characters);

			args = {
				character1 : characters[0],
				character2 : characters[1],
				dialogue : dialogues[1],
				questions : questions
			}
			populateDialogue($("#dialogue"), args);
			$("#subject").hide();
			showScript();
		}
		
		socket.on('start-timer', function(data){
			c = new Countdown($("#clock"), 
							 {duration : data.duration,
							  onStop : function(){
							  	$("#subject").submit();
							  }
							 })
			c.start();

		});

		socket.on('receive-question', function(data){
			console.log("received  question: " );
			console.log(data);
			questionReceived = true;
			questions[data.from] = {question : data.question, answer : data.answer};
			console.log(questions);
			if(questionSent){
				questionsComplete();
			}
		});

		function showOptions(){
			for(var i = 0; i < allSubjects.length; i++){
				$("#subject select").append("<option value='"+allSubjects[i]+"'>"+allSubjects[i]+"</option>")
			}
		}

		function showScript(){
			$("#dialogue").show();
			$(".response").show();
  			$("#answers li").hide();
  			$("#answers").show();
  			$(".elipses").remove();
  			$("p").show();
		}

		showOptions();
	}

	document.addEventListener("DOMContentLoaded", ready, false);

	</script>
</head>
<body>
	<div id="clock">
	</div>
	<div id="instructions">
		<div id="who">
			<p><span class="role actor1"></span> talking to <span class="role actor2"></span> (<b>YOU</b>)</p>
		</div>
		<form id="subject" action="">
			<p><label>Choose a subject to ask about</label> <select name=""></select> <input type="submit" value="ask" /></p>
		</form>
	</div>
	<div id="dialogue">
	</div>
</body>
</html>